import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.1b72a0e7.js";const A=JSON.parse('{"title":"七、Python 之 Websocket 基础操作","description":"","frontmatter":{},"headers":[],"relativePath":"零散知识/Python之websocket.md","lastUpdated":1700017374000}'),e={name:"零散知识/Python之websocket.md"},p=l(`<h1 id="七、python-之-websocket-基础操作" tabindex="-1">七、Python 之 Websocket 基础操作 <a class="header-anchor" href="#七、python-之-websocket-基础操作" aria-label="Permalink to &quot;七、Python 之 Websocket 基础操作&quot;">​</a></h1><p><a href="https://blog.csdn.net/captain5339/article/details/128212124" target="_blank" rel="noreferrer">Websocket 基础学习笔记</a></p><h2 id="一-websocket-介绍" tabindex="-1">一. websocket 介绍 <a class="header-anchor" href="#一-websocket-介绍" aria-label="Permalink to &quot;一. websocket 介绍&quot;">​</a></h2><h3 id="_1-1-简介" tabindex="-1">1.1 简介 <a class="header-anchor" href="#_1-1-简介" aria-label="Permalink to &quot;1.1 简介&quot;">​</a></h3><p>Websocket: 可以实现 客户端(client) 与 服务端(server) 之间的双向通信, 弥补了 http 无法保持长连接的不足. Websocket 协议本身有 <code>心跳机制、连接检测机制</code>，服务端无须关心客户端状态，一旦有异常，会自动断开连接</p><p>使用场景:</p><ul><li>html 页面实时更新、 网页游戏、聊天、证券交易等</li><li>实时通信类场景, 如位置服务、物联网、多方协作软件、在线教育等</li></ul><h3 id="_1-2-原理" tabindex="-1">1.2 原理 <a class="header-anchor" href="#_1-2-原理" aria-label="Permalink to &quot;1.2 原理&quot;">​</a></h3><blockquote><p>基于 TCP, 一次握手就能建立连接, 支持双向通信, 可保持长连接.</p><p><em>响应码为 <code>101</code>, 表示切换为 <code>websocket 协议</code></em></p></blockquote><p><img src="https://img.pupper.cn/img/202305081549136.jpg" alt=""></p><p>WebSocket 握手请求消息实例:</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">GET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/chat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">HTTP/</span><span style="color:#F78C6C;">1.1</span></span>
<span class="line"><span style="color:#FFCB6B;">Host:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">normal-website.com</span></span>
<span class="line"><span style="color:#FFCB6B;">Sec-WebSocket-Version:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">13</span></span>
<span class="line"><span style="color:#FFCB6B;">Sec-WebSocket-Key:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wDqumtseNBJdhkihL6PW7w==</span></span>
<span class="line"><span style="color:#FFCB6B;">Connection:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keep-alive,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Upgrade</span></span>
<span class="line"><span style="color:#FFCB6B;">Cookie:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2</span></span>
<span class="line"><span style="color:#FFCB6B;">Upgrade:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websocket</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果 Server 接收连接, 返回响应</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">HTTP/1.1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">101</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Switching</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Protocols</span></span>
<span class="line"><span style="color:#FFCB6B;">Connection:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Upgrade</span></span>
<span class="line"><span style="color:#FFCB6B;">Upgrade:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websocket</span></span>
<span class="line"><span style="color:#FFCB6B;">Sec-WebSocket-Accept:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">0FFP+2nmNIf/h+4BP36k9uzrYGk=</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="二-搭建-websocket-服务" tabindex="-1">二. 搭建 WebSocket 服务 <a class="header-anchor" href="#二-搭建-websocket-服务" aria-label="Permalink to &quot;二. 搭建 WebSocket 服务&quot;">​</a></h2><h3 id="_2-1-安装-websockets-包" tabindex="-1">2.1 安装 websockets 包 <a class="header-anchor" href="#_2-1-安装-websockets-包" aria-label="Permalink to &quot;2.1 安装 websockets 包&quot;">​</a></h3><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pip</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">websockets</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-2-编写-server-端代码" tabindex="-1">2.2 编写 server 端代码 <a class="header-anchor" href="#_2-2-编写-server-端代码" aria-label="Permalink to &quot;2.2 编写 server 端代码&quot;">​</a></h3><p>websockets 模块 server 端的主要方法:</p><ul><li><code>recv()</code> : 收消息</li><li><code>send()</code> : 发送消息</li><li><code>serve()</code> : 创建 server 对象</li></ul><p>实现步骤:</p><ol><li>编写 websocket 异步任务处理函数 handler</li><li>创建 1 个 websocket server 对象</li><li>异步运行 server 对象</li></ol><p>websocket 地址格式：</p><ul><li><strong>ws://主机地址:端口号</strong></li><li><strong>wss://主机地址:端口号</strong>， wss 表示此连接为 https 连接。</li></ul><div class="language-Python line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">Python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> asyncio</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> websockets</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> datetime </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> datetime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">handler</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">websocket</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># data = await websocket.recv()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># reply = f&quot;Data received as \\&quot;{data}\\&quot;.  time: {datetime.now()}&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># print(reply)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># await websocket.send(reply)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># print(&quot;Send reply&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> message </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> websocket</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        reply </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;Data received as </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">message</span><span style="color:#F78C6C;">}</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">.  time: </span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">datetime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">reply</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> websocket</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">reply</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> websockets</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">serve</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">handler</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">localhost</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">9999</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> asyncio</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Future</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># run forever</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> __name__ </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">__main__</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    asyncio</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">())</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在终端使用 <code>python -m websockets ws://localhost:9999</code> 代码连接服务端, 即可于服务端建立连接.</p><p><img src="https://img.pupper.cn/img/202305081725648.gif" alt=""></p><h3 id="_2-3-websocket-客户端实现代码" tabindex="-1">2.3 websocket 客户端实现代码 <a class="header-anchor" href="#_2-3-websocket-客户端实现代码" aria-label="Permalink to &quot;2.3 websocket 客户端实现代码&quot;">​</a></h3><p>websockets 客户端提供的主要方法:</p><ul><li><code>connect()</code> : 建立与服务器的连接</li><li><code>send()</code> : 发送消息</li><li><code>recv()</code> : 接收消息</li><li><code>close()</code> : 显式的关闭连接</li></ul><div class="language-Python line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">Python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> asyncio</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> websockets</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ws_client</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">40</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> websockets</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">connect</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> websocket</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> websocket</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;[</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">i</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">] - 客户端 → 服务端.&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#676E95;font-style:italic;"># 接收服务端返回的消息</span></span>
<span class="line"><span style="color:#A6ACCD;">            response </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">await</span><span style="color:#A6ACCD;"> websocket</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">recv</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">response</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">asyncio</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ws_client</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ws://localhost:9999</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div>`,31),o=[p];function t(c,r,i,y,D,F){return n(),a("div",null,o)}const b=s(e,[["render",t]]);export{A as __pageData,b as default};
